<% environment.context_class.instance_eval { include Rails.application.routes.url_helpers } %>

$(document).ready(function() {  
  function map_setup() {
    var mapOptions = {
      // center on the U.S. for now
      center: new google.maps.LatLng(35.0, -9.0),
      zoom: 2,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    var map = new google.maps.Map(document.getElementById("map-canvas"),
        mapOptions);


    set_markers(map)
  }

  function set_markers(map) {
    centers = ( $("#map-canvas").data("centers") );

    markers = new Array();
    //info_windows = new Array();

    // loop through each of the centers and create a marker for each one using the lat and long attributes
    info_window = new google.maps.InfoWindow({});

    count = 0;
    $.each(centers, function() {
       markers[count] = new google.maps.Marker({
                                    position: new google.maps.LatLng(this["address"]["latitude"],this["address"]["longitude"]),
                                    map: map
                                 });
       count += 1
    });

    for (var i=0;i< markers.length;i++)
    {
      bind_info_window(markers[i], map, info_window, centers[i]["center_link"], centers[i]["name"], centers[i]["address"]["city"]["name"]);
    }
  }

  // need this closure in order for the the multiple info window thing to work
  function bind_info_window(marker, map, info_window, center_link, center_name, center_city) {
    google.maps.event.addListener(marker, 'click', function() {
      var complete_link = '<div><a href="' + center_link + '">' + center_name + '</a><br />' + center_city + '</div>'
      // only the first word of the center is showing up
      info_window.setContent(complete_link);
      info_window.open(map, marker);
    });
  }

  google.maps.event.addDomListener(window, 'load', map_setup);

});
